# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1eRxFs6whIBxrYO6Foex3N20dQZfb8egx
"""

# Commented out IPython magic to ensure Python compatibility.
import sys
if 'google.colab' in sys.modules:
#   %pip install streamlit
import streamlit as st
import matplotlib.pyplot as plt
import matplotlib.patches as patches
import numpy as np

# è¨­å®šé é¢è³‡è¨Š
st.set_page_config(page_title="Probe Card Mechanics Demo", page_icon="ğŸ”¬", layout="wide")

st.title("ğŸ”¬ Probe Card Mechanics: Why Isolated Pins Fail?")
st.markdown("""
æ­¤æ‡‰ç”¨ç¨‹å¼æ¨¡æ“¬æ¢é‡å¡åœ¨ **Wafer Edge (æ™¶åœ“é‚Šç·£)** çš„å—åŠ›è¡Œç‚ºã€‚
ä¸»è¦å±•ç¤ºç‚ºä»€éº¼ **Isolated Pin (å­¤ç«‹é‡)** æ¯” **Grouped Pins (ç¾¤çµ„é‡)** æ›´å®¹æ˜“ç™¼ç”Ÿåä½èˆ‡è®Šå½¢ã€‚
""")

# Sidebar æ§åˆ¶é …
st.sidebar.header("Simulation Settings")
scenario = st.sidebar.radio(
    "é¸æ“‡æƒ…å¢ƒ (Scenario):",
    ("Scenario A: Grouped Pins (Safe)", "Scenario B: Isolated Pin (Risk)")
)

show_force = st.sidebar.checkbox("Show Force Vectors (é¡¯ç¤ºå—åŠ›)", value=True)

# ç¹ªåœ–å‡½æ•¸
def draw_mechanics(mode):
    fig, ax = plt.subplots(figsize=(10, 6))

    # --- 1. ç¹ªè£½æ™¶åœ“èˆ‡ Pad (Wafer & Pads) ---
    # å®šç¾©æ™¶åœ“è¼ªå»“ (åŒ…å«å¹³å¦å€èˆ‡æ–œå¡)
    x_wafer = np.linspace(0, 10, 100)
    # æ–œå¡å¾ x=8 é–‹å§‹
    y_wafer = np.array([2.0 if x < 8 else 2.0 - (x-8)*1.5 for x in x_wafer])

    # å¡«å……æ™¶åœ“å€åŸŸ
    ax.fill_between(x_wafer, 0, y_wafer, color='#E0E0E0', label='Wafer Substrate')
    ax.text(4, 1.0, "Silicon Wafer", color='gray', fontsize=12, ha='center')
    ax.text(9, 0.5, "Edge Bevel\n(æ–œå¡)", color='gray', fontsize=10, ha='center', rotation=-45)

    # ç¹ªè£½ Pads (é‡‘å±¬å¢Š)
    if mode == 'Grouped':
        rect1 = patches.Rectangle((2, 2.0), 1, 0.2, linewidth=0, edgecolor='none', facecolor='#FFD700') # Pad 1
        rect2 = patches.Rectangle((4.5, 2.0), 1, 0.2, linewidth=0, edgecolor='none', facecolor='#FFD700') # Pad 2
        ax.add_patch(rect1)
        ax.add_patch(rect2)
        ax.text(2.5, 1.8, "Pad", ha='center', fontsize=9)
        ax.text(5.0, 1.8, "Pad", ha='center', fontsize=9)
    else:
        # Isolated æ¨¡å¼ä¸‹æ²’æœ‰ Pad åœ¨é™„è¿‘
        pass

    # --- 2. ç¹ªè£½æ¢é‡å¡åº§ (Probe Head) ---
    head_color = '#444444'
    pin_color = '#000000'

    # æ ¹æ“šæ¨¡å¼æ±ºå®š Z è»¸é«˜åº¦ (Overdrive ç¨‹åº¦)
    # Grouped: è¢« Pad é ‚ä½ï¼Œåœåœ¨è¼ƒé«˜ä½ç½® (y=7)
    # Isolated: æ²’äººé ‚ä½ï¼Œç¹¼çºŒä¸‹å£“ (Overdrive)ï¼Œé™åˆ° y=6
    head_y_bottom = 7.0 if mode == 'Grouped' else 6.0

    rect_head = patches.Rectangle((1, head_y_bottom), 8.5, 1.0, linewidth=0, facecolor=head_color, alpha=0.7)
    ax.add_patch(rect_head)
    ax.text(5.25, head_y_bottom + 0.4, "Probe Card Head (Ceramic/Space Transformer)",
            color='white', ha='center', fontsize=10)

    # --- 3. ç¹ªè£½æ¢é‡ (Needles) ---

    if mode == 'Grouped':
        # Pin 1 (Safe)
        ax.plot([2.5, 2.5], [2.2, head_y_bottom], color=pin_color, linewidth=3)
        # Pin 2 (Safe)
        ax.plot([5.0, 5.0], [2.2, head_y_bottom], color=pin_color, linewidth=3)
        # Pin 3 (Edge Pin - Safe because Head is stopped)
        # é‡é•·å›ºå®šï¼Œæ‰€ä»¥å¦‚æœ Head åœ¨ 7.0ï¼Œé‡å°–ç´„åœ¨ 7.0 - 4.8 = 2.2 å·¦å³
        # é€™è£¡ç•«å®ƒæ‡¸ç©ºæˆ–è¼•è§¸æ–œå¡ä¸Šæ–¹
        ax.plot([8.5, 8.5], [head_y_bottom - 4.8, head_y_bottom], color=pin_color, linewidth=3, linestyle='--')

        ax.scatter([2.5, 5.0], [2.2, 2.2], color='red', zorder=5, s=50) # Contact points

        status_text = "SAFE: Supported by neighbors"
        status_color = 'green'

        if show_force:
            # ç•«æ”¯æ’åŠ›ç®­é ­ (Support Force)
            ax.arrow(2.5, 2.2, 0, 1.5, head_width=0.2, head_length=0.3, fc='blue', ec='blue', label='Support')
            ax.arrow(5.0, 2.2, 0, 1.5, head_width=0.2, head_length=0.3, fc='blue', ec='blue')
            ax.text(3.75, 4.0, "Reaction Force\n(Support)", color='blue', ha='center', fontweight='bold')

    else: # Isolated
        # Pin (Edge Pin - Risk)
        # Head ä¸‹é™åˆ° 6.0 (Overdrive)
        # é‡è¢«å£“å½äº†ï¼
        # èµ·é» (Head): (8.5, 6.0)
        # çµ‚é» (Wafer Edge): æ»‘ç§»åˆ° (9.0, 0.5) (å‡è¨­æ»‘ä¸‹å»äº†)
        # ä¸­é–“å½æ›²é» (Buckling)

        # ä½¿ç”¨è²èŒ²æ›²ç·šæˆ–ç°¡å–®æŠ˜ç·šæ¨¡æ“¬å½æ›²
        # é€™è£¡ç”¨ç°¡å–®æŠ˜ç·šè¡¨ç¤º
        x_bent = [8.5, 8.3, 9.2] # Head -> Buckle -> Tip
        y_bent = [head_y_bottom, 3.5, 0.2] # Head -> Middle -> Slope

        ax.plot(x_bent, y_bent, color='red', linewidth=4)
        ax.scatter([9.2], [0.2], color='red', zorder=5, s=100, marker='x') # Crash point

        status_text = "FAIL: Needle Sliding & Bending!"
        status_color = 'red'

        if show_force:
            # ä¸‹å£“åŠ›
            ax.arrow(8.5, head_y_bottom, 0, -1.5, head_width=0.2, fc='black', ec='black')
            ax.text(8.7, 5.0, "Overdrive\n(No Stop)", color='black', ha='left')

            # å´å‘æ»‘å‹•åŠ›
            ax.arrow(9.2, 0.2, 0.8, -0.8, head_width=0.2, fc='red', ec='red')
            ax.text(9.5, 0.5, "Slip / Skid", color='red', ha='left', fontweight='bold')

    # --- 4. ç‰ˆé¢ä¿®é£¾ ---
    ax.set_xlim(0, 11)
    ax.set_ylim(-1, 9)
    ax.set_aspect('equal')
    ax.axis('off') # éš±è—åº§æ¨™è»¸

    # æ¨™é¡Œèˆ‡ç‹€æ…‹
    plt.title(f"{mode} Configuration", fontsize=16, fontweight='bold')
    plt.text(5.5, -0.8, status_text, color=status_color, fontsize=14, fontweight='bold', ha='center',
             bbox=dict(facecolor='white', edgecolor=status_color, boxstyle='round,pad=0.5'))

    return fig

# Streamlit å‘ˆç¾é‚è¼¯
col1, col2 = st.columns([1, 2])

with col1:
    st.info("### ğŸ“ Engineering Note")
    if scenario == "Scenario A: Grouped Pins (Safe)":
        st.markdown("""
        **æ©Ÿåˆ¶èªªæ˜ (Mechanism):**
        * **Z-Stop Effect**: å…§å´çš„æ¢é‡ (Pins 1 & 2) ç©©å›ºåœ°æ¥è§¸ Padï¼Œæä¾›äº†åä½œç”¨åŠ›ã€‚
        * **Protection**: é€™äº›åä½œç”¨åŠ›é˜»æ­¢äº† Probe Head ç¹¼çºŒéåº¦ä¸‹å£“ã€‚
        * **Result**: æœ€å¤–å´çš„é‡ (Pin 3) å³ä½¿æ‡¸ç©ºæˆ–æ¥è§¸é‚Šç·£ï¼Œä¹Ÿä¸æœƒæ‰¿å—éå¤§çš„å£“åŠ›ã€‚
        """)
    else:
        st.error("""
        **æ©Ÿåˆ¶èªªæ˜ (Mechanism):**
        * **No Support**: å­¤ç«‹é‡å‘¨åœæ²’æœ‰é„°å±…æä¾›æ”¯æ’ã€‚
        * **Overdrive**: æ©Ÿå°æŒçºŒä¸‹å£“å°‹æ‰¾æ¥è§¸è¨Šè™Ÿã€‚
        * **Sliding**: é‡å°–æ¥è§¸æ–œå¡ (Bevel) æ™‚ï¼Œå‚ç›´åŠ›è½‰ç‚º **å´å‘åŠ› (Lateral Force)**ã€‚
        * **Result**: é‡å°–æ»‘ç§» (Skid)ï¼Œé‡èº«ç™¼ç”Ÿå¡‘æ€§è®Šå½¢ (Permanent Deformation)ã€‚é€™å°è‡´è©²é‡ä½æœªä¾†æ¸¬è©¦æ™‚æœƒç”¢ç”Ÿ **Probe Mark Shift**ã€‚
        """)

with col2:
    mode_key = 'Grouped' if "Grouped" in scenario else 'Isolated'
    fig = draw_mechanics(mode_key)
    st.pyplot(fig)

st.write("---")
st.caption("Generated by Gemini Quality Engineering Assistant for Irene.")